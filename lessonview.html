<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mwalimu - Lesson View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .lesson-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        .lesson-content p {
            line-height: 1.75;
            margin-bottom: 1rem;
        }

        .lesson-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .lesson-content code {
            background-color: #e5e7eb;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="text-gray-800 bg-gray-50">
    <div id="mwalimu-lesson-view">
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="dashboard.html" class="text-gray-500 hover:text-gray-900 font-semibold">&larr; Back to
                        Dashboard</a>
                    <div id="profile-section" class="relative"></div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col lg:flex-row lg:space-x-8">
                <div class="lg:w-2/3 bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <div id="lesson-content" class="lesson-content"></div>
                </div>

                <div class="lg:w-1/3 mt-8 lg:mt-0">
                    <div class="sticky top-24">
                        <div class="bg-white rounded-xl shadow-lg flex flex-col h-[calc(100vh-8rem)]">
                            <div class="p-4 border-b">
                                <h3 class="font-bold text-lg text-center">Mwalimu Assistant</h3>
                            </div>
                            <div id="chat-window" class="flex-1 p-4 overflow-y-auto">
                                <div class="flex mb-4">
                                    <div class="bg-teal-100 text-teal-800 p-3 rounded-lg max-w-xs">
                                        <p>Ask me a question about today's lesson content!</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-50 border-t">
                                <form id="chat-form" class="flex items-center space-x-2">
                                    <input id="chat-input" type="text" placeholder="Ask a question..."
                                        class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <button type="submit"
                                        class="bg-teal-600 text-white p-2 rounded-full hover:bg-teal-700">
                                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let userProfile = {};

        document.addEventListener('DOMContentLoaded', () => {
            const storedProfile = localStorage.getItem('mwalimuUserProfile');
            const storedLesson = sessionStorage.getItem('mwalimuLessonData');

            if (!storedProfile || !storedLesson) {
                alert('Session data not found. Redirecting to dashboard.');
                window.location.href = 'dashboard.html';
                return;
            }
            userProfile = JSON.parse(storedProfile);
            const lessonData = JSON.parse(storedLesson);

            // renderProfile(userProfile); // You can add your profile rendering function here
            loadLessonContent(lessonData);
            setupChat(userProfile.email);
        });

        // In lessonview.html, replace the existing functions with these

        function loadLessonContent(data) {
            const lessonContentEl = document.getElementById('lesson-content');
            // The new version is much simpler. It just parses the whole lesson plan at once.
            if (data && data.lesson_plan) {
                lessonContentEl.innerHTML = marked.parse(data.lesson_plan);
            }
        }

        function setupChat(email) {
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');

            // This function now uses marked.parse() to render the AI's response
            const addMessage = (message, sender) => {
                const chatWindow = document.getElementById('chat-window');
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('flex', 'mb-4');
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'prose'); // 'prose' class from tailwind for nice typography

                if (sender === 'user') {
                    messageWrapper.classList.add('justify-end');
                    messageBubble.classList.add('bg-teal-600', 'text-white');
                    messageBubble.textContent = message; // User messages don't need markdown parsing
                } else { // 'ai'
                    messageWrapper.classList.add('justify-start');
                    messageBubble.classList.add('bg-gray-200', 'text-gray-800');
                    messageBubble.innerHTML = marked.parse(message); // AI messages ARE parsed
                }

                messageWrapper.appendChild(messageBubble);
                chatWindow.appendChild(messageWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageBubble;
            };

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;

                addMessage(userMessage, 'user');
                chatInput.value = '';
                const thinkingBubble = addMessage('Generating your answer. This may take 2 min...', 'ai');

                try {
                    const response = await fetch(`${API_URL}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, prompt: userMessage })
                    });
                    if (!response.ok) throw new Error((await response.json()).detail);
                    const result = await response.json();
                    // Update the bubble by parsing the markdown response
                    thinkingBubble.innerHTML = marked.parse(result.response);
                } catch (error) {
                    thinkingBubble.textContent = `Error: ${error.message}`;
                }
            });
        }
    </script>
</body>

</html>