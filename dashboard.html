<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mwalimu - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        h1, h2, h3 { font-family: 'Nunito', sans-serif; }
    </style>
</head>
<body class="text-gray-800">
    <div id="mwalimu-dashboard" class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-auto text-teal-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.75 14.5a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zM12 11a3 3 0 100-6 3 3 0 000 6zm5.75 5.5a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zM12 13a2 2 0 110-4 2 2 0 010 4z"/></svg>
                        <span class="ml-2 text-xl font-bold text-gray-800">Mwalimu</span>
                    </div>
                    <div id="profile-section" class="relative"></div>
                </div>
            </div>
        </header>

        <main class="py-10">
            <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="lesson-card" class="bg-white rounded-xl shadow-lg overflow-hidden">
                    </div>

                <div id="mark-complete-section" class="mt-6 hidden">
                    <button id="mark-complete-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-offset-2 flex items-center justify-center transition-opacity disabled:opacity-50 disabled:cursor-wait">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>
                        Mark as Complete & Prepare Next Lesson
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let userProfile = {};

        document.addEventListener('DOMContentLoaded', () => {
            const storedProfile = localStorage.getItem('mwalimuUserProfile');
            if (!storedProfile) {
                window.location.href = 'onboarding.html';
                return;
            }
            userProfile = JSON.parse(storedProfile);
            renderProfile(userProfile);
            loadPageContent();
        });
        
        function renderProfile(profile) { /* ... same as your old script ... */ }

        async function loadPageContent() {
            const lessonCard = document.getElementById('lesson-card');
            const markCompleteSection = document.getElementById('mark-complete-section');
            const storedLesson = sessionStorage.getItem('mwalimuLessonData');

            if (storedLesson) {
                // If a lesson is already in session storage, just render it.
                renderLesson(JSON.parse(storedLesson));
            } else {
                // Otherwise, fetch a new lesson from the server.
                lessonCard.innerHTML = getLoadingHTML();
                try {
                    const response = await fetch(`${API_URL}/start_lesson/${userProfile.email}`);
                    if (!response.ok) throw new Error((await response.json()).detail);
                    const data = await response.json();
                    sessionStorage.setItem('mwalimuLessonData', JSON.stringify(data));
                    renderLesson(data);
                } catch (error) {
                    lessonCard.innerHTML = getErrorHTML(error.message);
                }
            }
            markCompleteSection.classList.remove('hidden');
            document.getElementById('mark-complete-btn').addEventListener('click', handleMarkComplete);
        }
        
        function renderLesson(data) {
            const lessonCard = document.getElementById('lesson-card');
            const topicsHtml = data.topics.map(topic => 
                `<li class="flex items-center"><span class="h-2 w-2 bg-teal-500 rounded-full mr-3"></span>${topic}</li>`
            ).join('');

            lessonCard.innerHTML = `
                <div class="p-6 sm:p-8">
                    <h2 class="text-2xl font-bold text-gray-900">Today's Focus: ${data.topics[0]}</h2>
                    <p class="mt-2 text-gray-600">Here is the lesson content prepared by your AI assistant.</p>
                    <div class="mt-6 border-t pt-6"><h3 class="text-lg font-semibold">Topics for today:</h3><ul class="mt-4 space-y-3">${topicsHtml}</ul></div>
                    <div class="mt-8">
                        <a href="lessonview.html" class="block text-center w-full bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-teal-700">
                            View Full Lesson & Chat with Mwalimu
                        </a>
                    </div>
                </div>`;
        }

        async function handleMarkComplete() {
            const lessonCard = document.getElementById('lesson-card');
            const completeBtn = document.getElementById('mark-complete-btn');
            completeBtn.disabled = true;
            completeBtn.innerHTML = 'Preparing next lesson...';
            lessonCard.innerHTML = getLoadingHTML("Preparing your next lesson...");

            try {
                const response = await fetch(`${API_URL}/mark_and_get_next_lesson/${userProfile.email}`, { method: 'POST' });
                if (!response.ok) throw new Error((await response.json()).detail);
                const data = await response.json();
                sessionStorage.setItem('mwalimuLessonData', JSON.stringify(data));
                renderLesson(data);
            } catch (error) {
                lessonCard.innerHTML = getErrorHTML(error.message);
            } finally {
                completeBtn.disabled = false;
                completeBtn.innerHTML = 'Mark as Complete & Prepare Next Lesson';
            }
        }

        function getLoadingHTML(message = "Mwalimu is preparing your lesson...") {
            return `<div class="p-8 text-center"><h2 class="text-2xl font-bold">${message}</h2><div class="mt-6 h-4 bg-gray-200 rounded w-3/4 mx-auto animate-pulse"></div></div>`;
        }
        function getErrorHTML(errorMessage) {
            return `<div class="p-8 text-center text-red-600"><h2 class="text-2xl font-bold">Failed to Load Lesson</h2><p class="mt-2">${errorMessage}</p></div>`;
        }
    </script>
</body>
</html>