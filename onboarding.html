<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mwalimu - Onboarding</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F9F9F9; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Nunito', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        .drag-over { border-color: #4A908A; background-color: #F0F7F7; }
    </style>
</head>
<body class="text-gray-800">
    <div id="mwalimu-app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Step 1: Welcome Splash -->
        <div id="step-1" class="w-full max-w-lg text-center fade-in">
            <svg class="mx-auto h-16 w-auto text-teal-600" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.75 14.5a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zM12 11a3 3 0 100-6 3 3 0 000 6zm5.75 5.5a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zM12 13a2 2 0 110-4 2 2 0 010 4z"/></svg>
            <h1 class="mt-6 text-3xl font-bold text-gray-900">Welcome, Teacher.</h1>
            <h2 class="mt-2 text-xl text-gray-600">Let's build your personal teaching assistant.</h2>
            <button id="get-started-btn" class="mt-10 w-full max-w-xs bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-transform transform hover:scale-105">Get Started</button>
        </div>

        <!-- Step 2: Core Information -->
        <div id="step-2" class="w-full max-w-lg hidden">
            <h2 class="text-2xl font-bold text-center">Tell us about yourself</h2>
            <form id="onboarding-form" class="mt-8 space-y-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" name="name" id="name" required class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <!-- Email field is required by the backend -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" name="email" id="email" required class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="school" class="block text-sm font-medium text-gray-700">School / Institution</label>
                    <input type="text" name="school" id="school" required class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Subject Taught</label>
                    <input type="text" name="subject" id="subject" placeholder="e.g., Software Engineering, Physics" required class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700">Grade / Class Level</label>
                    <input type="text" name="grade" id="grade" placeholder="e.g., 10th Grade, University Year 2" required class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-transform transform hover:scale-105">Next</button>
                </div>
            </form>
        </div>
        
        <!-- Step 3: Syllabus Upload -->
        <div id="step-3" class="w-full max-w-lg hidden">
            <h2 class="text-2xl font-bold text-center">Upload Your Syllabus</h2>
            <form id="syllabus-form" class="mt-8 space-y-6">
                <div id="drop-zone" class="flex justify-center items-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="text-center" id="drop-zone-text">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2"/></svg>
                        <p class="mt-2 text-sm text-gray-600"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                    </div>
                    <input id="syllabus-file-input" type="file" class="hidden" accept=".pdf,.png,.jpg,.jpeg">
                </div>
                <div id="file-preview" class="hidden mt-4">
                    <div class="flex items-center bg-white p-3 rounded-lg shadow-sm border">
                        <span id="file-name" class="ml-3 text-sm font-medium text-gray-700 truncate"></span>
                        <button type="button" id="remove-file-btn" class="ml-auto text-gray-500 hover:text-red-600 text-2xl leading-none">&times;</button>
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" id="next-to-step-4" class="w-full bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Next</button>
                </div>
            </form>
        </div>

        <!-- Step 4: Completed Topics -->
        <div id="step-4" class="w-full max-w-lg hidden">
            <h2 class="text-2xl font-bold text-center">Pinpoint Your Progress</h2>
            <form id="progress-form" class="mt-8 space-y-6">
                <div>
                    <label for="completed-topics" class="sr-only">Completed Topics</label>
                    <textarea id="completed-topics" name="completed-topics" rows="4" class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Introduction to Data Structures..."></textarea>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700">Finish & Prepare First Lesson</button>
                </div>
            </form>
        </div>
        
        <!-- Step 5: Loading/Status Screen -->
        <div id="step-5" class="w-full max-w-lg hidden text-center">
            <div id="loading-spinner">
                <svg class="mx-auto h-16 w-auto text-teal-600 animate-pulse" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.75 14.5a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zM12 11a3 3 0 100-6 3 3 0 000 6zm5.75 5.5a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zM12 13a2 2 0 110-4 2 2 0 010 4z"/></svg>
            </div>
            <h2 id="loading-title" class="mt-6 text-2xl font-bold text-gray-900">Mwalimu is Preparing Your Space</h2>
            <div id="loading-animation" class="mt-4 overflow-hidden h-6 text-lg text-gray-600">
                <div id="loading-messages" class="transition-transform duration-500 ease-in-out">
                    <p class="h-6">Analyzing your curriculum...</p>
                    <p class="h-6">Sourcing the best educational materials...</p>
                    <p class="h-6">Building your personalized knowledge base...</p>
                    <p class="h-6">Done! Preparing your first lesson plan.</p>
                </div>
            </div>
            <p id="error-message" class="hidden mt-4 text-red-600 font-semibold"></p>
        </div>
    </div>

    <script>
        const steps = { 1: document.getElementById('step-1'), 2: document.getElementById('step-2'), 3: document.getElementById('step-3'), 4: document.getElementById('step-4'), 5: document.getElementById('step-5') };
        const getStartedBtn = document.getElementById('get-started-btn');
        const onboardingForm = document.getElementById('onboarding-form');
        const syllabusForm = document.getElementById('syllabus-form');
        const progressForm = document.getElementById('progress-form');
        const dropZone = document.getElementById('drop-zone');
        const syllabusFileInput = document.getElementById('syllabus-file-input');
        const filePreview = document.getElementById('file-preview');
        const fileNameEl = document.getElementById('file-name');
        const removeFileBtn = document.getElementById('remove-file-btn');
        const loadingTitle = document.getElementById('loading-title');
        const loadingAnimation = document.getElementById('loading-animation');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');

        const userProfile = {};
        let syllabusFile = null;
        const API_URL = 'http://127.0.0.1:8000';

        const goToStep = (currentStepNum, nextStepNum) => {
            steps[currentStepNum].classList.add('fade-out');
            setTimeout(() => {
                steps[currentStepNum].classList.add('hidden');
                steps[nextStepNum].classList.remove('hidden');
                steps[nextStepNum].classList.add('fade-in');
            }, 500);
        };

        const handleFile = (file) => {
            if (!file) return;
            syllabusFile = file;
            fileNameEl.textContent = file.name;
            filePreview.classList.remove('hidden');
            document.getElementById('drop-zone-text').classList.add('hidden');
            document.getElementById('next-to-step-4').disabled = false;
        };
        
        const removeFile = () => {
            syllabusFile = null;
            syllabusFileInput.value = '';
            filePreview.classList.add('hidden');
            document.getElementById('drop-zone-text').classList.remove('hidden');
            document.getElementById('next-to-step-4').disabled = true;
        };

        getStartedBtn.addEventListener('click', () => goToStep(1, 2));

        onboardingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(onboardingForm);
            userProfile.name = formData.get('name');
            userProfile.email = formData.get('email');
            userProfile.school = formData.get('school');
            userProfile.subject = formData.get('subject');
            userProfile.grade = formData.get('grade');
            goToStep(2, 3);
        });
        
        dropZone.addEventListener('click', () => syllabusFileInput.click());
        syllabusFileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        removeFileBtn.addEventListener('click', removeFile);
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });

        syllabusForm.addEventListener('submit', (e) => { e.preventDefault(); if (syllabusFile) goToStep(3, 4); });

        // *** THIS IS THE CORRECTED SCRIPT ***
        progressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            goToStep(4, 5); // Go to loading screen

            const formData = new FormData();
            formData.append('name', userProfile.name);
            formData.append('email', userProfile.email);
            formData.append('subject', userProfile.subject);
            formData.append('grade', userProfile.grade);
            formData.append('completed_topics', document.getElementById('completed-topics').value);
            formData.append('syllabus_file', syllabusFile);

            try {
                const response = await fetch(`${API_URL}/onboard`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Onboarding failed. Please try again.');
                }

                const result = await response.json();

                sessionStorage.clear(); // Clear old lesson data before redirecting

                
                // On SUCCESS, save profile to localStorage
                localStorage.setItem('mwalimuUserProfile', JSON.stringify({ 
                    name: result.name, 
                    email: result.email, 
                    school: userProfile.school 
                }));
                
                // Start success animation and redirect
                let messageIndex = 0;
                const intervalId = setInterval(() => {
                    messageIndex++;
                    document.getElementById('loading-messages').style.transform = `translateY(-${messageIndex * 1.5}rem)`;
                    if (messageIndex >= 3) {
                        clearInterval(intervalId);
                        // Redirect to the dashboard
                        window.location.href = 'dashboard.html';
                    }
                }, 1000);

            } catch (error) {
                // On FAILURE, show an error message
                loadingTitle.textContent = 'An Error Occurred';
                errorMessage.textContent = `Error: ${error.message}. Please ensure the backend is running and try again.`;
                loadingAnimation.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                console.error('Onboarding Error:', error);
            }
        });
    </script>
</body>
</html>
